<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>For Founders - Berean</title>
    <meta name="description" content="9 leadership protocols grounded in Scripture, validated by neuroscience, behavioral science, and management research. Ancient principles. Modern evidence.">
    <link rel="stylesheet" href="css/styles.css?v=20260221">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Crimson+Pro:ital,wght@0,400;0,500;0,600;1,400&family=Inter:wght@400;500;600;700;800&family=Playfair+Display:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
</head>
<body class="fp-body">

    <!-- ===============================================
         LEVEL 1: PROTOCOL INDEX
         =============================================== -->
    <div id="protocolIndex">
        <!-- Sticky Nav -->
        <nav class="fp-nav">
            <div class="fp-nav-inner">
                <a href="index.html" class="fp-logo">berean</a>
                <div class="fp-nav-right">
                    <a href="daily.html" class="fp-nav-link" data-en="Daily Verse" data-es="Verso Diario">Daily Verse</a>
                    <div class="lang-toggle">
                        <button class="lang-btn active" data-lang="en">EN</button>
                        <button class="lang-btn" data-lang="es">ES</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Hero -->
        <header class="fp-header">
            <span class="fp-eyebrow" data-en="BEREAN FOR FOUNDERS" data-es="BEREAN PARA FUNDADORES">BEREAN FOR FOUNDERS</span>
            <h1 class="fp-headline" data-en="Ancient Principles. Modern Evidence." data-es="Principios Antiguos. Evidencia Moderna.">Ancient Principles. Modern Evidence.</h1>
            <p class="fp-subline" data-en="9 leadership protocols grounded in Scripture, validated by neuroscience, behavioral science, and management research." data-es="9 protocolos de liderazgo fundamentados en las Escrituras, validados por neurociencia, ciencia del comportamiento e investigaci&oacute;n en gesti&oacute;n.">9 leadership protocols grounded in Scripture, validated by neuroscience, behavioral science, and management research.</p>
            <div class="fp-disciplines">
                <span class="fp-discipline" data-en="Biblical Exegesis" data-es="Ex&eacute;gesis B&iacute;blica">Biblical Exegesis</span>
                <span class="fp-discipline" data-en="Neuroscience" data-es="Neurociencia">Neuroscience</span>
                <span class="fp-discipline" data-en="Behavioral Science" data-es="Ciencia del Comportamiento">Behavioral Science</span>
                <span class="fp-discipline" data-en="Management Research" data-es="Investigaci&oacute;n en Gesti&oacute;n">Management Research</span>
            </div>
            <p class="fp-credibility" id="credibilityLine"></p>
        </header>

        <!-- About This Research (collapsible) -->
        <div class="fp-about-wrap">
            <details class="fp-about">
                <summary class="fp-about__toggle">
                    <span data-en="About this research" data-es="Sobre esta investigaci&oacute;n">About this research</span>
                    <svg class="fp-about__icon" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
                </summary>
                <div class="fp-about__body">
                    <p data-en="Each protocol begins with a Scripture passage that has guided leaders for millennia. We then validate its principles through five evidence lenses: biblical scholarship, business context, neuroscience, behavioral science, and management research. Every claim is sourced." data-es="Cada protocolo comienza con un pasaje de las Escrituras que ha guiado a l&iacute;deres por milenios. Luego validamos sus principios a trav&eacute;s de cinco lentes de evidencia: erudici&oacute;n b&iacute;blica, contexto empresarial, neurociencia, ciencia del comportamiento e investigaci&oacute;n en gesti&oacute;n. Cada afirmaci&oacute;n tiene fuentes.">Each protocol begins with a Scripture passage that has guided leaders for millennia. We then validate its principles through five evidence lenses: biblical scholarship, business context, neuroscience, behavioral science, and management research. Every claim is sourced.</p>
                    <p class="fp-about__anti-pitch" data-en="No devotionals. No motivational quotes. Primary sources. Tested frameworks. Applied leadership." data-es="Sin devocionales. Sin frases motivacionales. Fuentes primarias. Marcos probados. Liderazgo aplicado.">No devotionals. No motivational quotes. Primary sources. Tested frameworks. Applied leadership.</p>
                </div>
            </details>
        </div>

        <!-- Category Tabs -->
        <div class="fp-tabs-wrap">
            <div class="fp-tabs" id="categoryTabs">
                <button class="fp-tab fp-tab--active" data-category="all" data-en="All (9)" data-es="Todos (9)">All (9)</button>
                <button class="fp-tab" data-category="leadership" data-en="Leadership" data-es="Liderazgo">Leadership</button>
                <button class="fp-tab" data-category="strategy" data-en="Strategy" data-es="Estrategia">Strategy</button>
                <button class="fp-tab" data-category="resilience" data-en="Resilience" data-es="Resiliencia">Resilience</button>
                <button class="fp-tab" data-category="ethics" data-en="Ethics" data-es="&Eacute;tica">Ethics</button>
            </div>
        </div>

        <!-- Protocol Cards -->
        <main class="fp-container">
            <div class="fp-cards" id="protocolCards"></div>
        </main>
    </div>

    <!-- ===============================================
         LEVEL 2: PROTOCOL DETAIL
         =============================================== -->
    <div id="protocolDetail" style="display:none;">
        <!-- Sticky Nav -->
        <nav class="fp-nav">
            <div class="fp-nav-inner">
                <button class="fp-back-btn" id="backToIndex">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 12H5M12 19l-7-7 7-7"/></svg>
                    <span data-en="All Protocols" data-es="Todos los Protocolos">All Protocols</span>
                </button>
                <span class="fp-nav-title" id="detailNavTitle"></span>
                <div class="fp-nav-right">
                    <div class="lang-toggle">
                        <button class="lang-btn active" data-lang="en">EN</button>
                        <button class="lang-btn" data-lang="es">ES</button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Detail Header -->
        <header class="fp-detail-header" id="detailHeader"></header>

        <!-- Detail Body: TOC + Content -->
        <div class="fp-detail-body">
            <!-- Sticky TOC Sidebar (desktop) / Horizontal bar (mobile) -->
            <aside class="fp-toc" id="tocSidebar">
                <div class="fp-toc__inner">
                    <button class="fp-toc__item fp-toc__item--active" data-target="sectionScripture">
                        <span class="fp-toc__dot"></span>
                        <span data-en="Scripture" data-es="Escritura">Scripture</span>
                    </button>
                    <button class="fp-toc__item" data-target="sectionEvidence">
                        <span class="fp-toc__dot"></span>
                        <span data-en="Evidence" data-es="Evidencia">Evidence</span>
                    </button>
                    <button class="fp-toc__item" data-target="sectionProtocol">
                        <span class="fp-toc__dot"></span>
                        <span data-en="Protocol" data-es="Protocolo">Protocol</span>
                    </button>
                    <button class="fp-toc__item" data-target="sectionTeam">
                        <span class="fp-toc__dot"></span>
                        <span data-en="Team" data-es="Equipo">Team</span>
                    </button>
                    <button class="fp-toc__item" data-target="sectionReflect">
                        <span class="fp-toc__dot"></span>
                        <span data-en="Reflect" data-es="Reflexionar">Reflect</span>
                    </button>
                    <label class="fp-complete-check" id="markCompleteLabel">
                        <input type="checkbox" id="markCompleteCheckbox">
                        <span class="fp-complete-check__box"></span>
                        <span data-en="Mark Complete" data-es="Marcar Completo">Mark Complete</span>
                    </label>
                </div>
            </aside>

            <!-- Content -->
            <div class="fp-content">
                <!-- 1. Scripture -->
                <section class="fp-section" id="sectionScripture">
                    <span class="fp-section__eyebrow" data-en="THE SCRIPTURE" data-es="LA ESCRITURA">THE SCRIPTURE</span>
                    <div class="fp-scripture" id="scriptureCard"></div>
                </section>

                <!-- 2. The Evidence -->
                <section class="fp-section" id="sectionEvidence">
                    <span class="fp-section__eyebrow" data-en="THE EVIDENCE" data-es="LA EVIDENCIA">THE EVIDENCE</span>
                    <p class="fp-section__intro" data-en="Ancient wisdom validated by modern research." data-es="Sabidur&iacute;a antigua validada por investigaci&oacute;n moderna.">Ancient wisdom validated by modern research.</p>
                    <div class="fp-evidence" id="evidenceAccordions"></div>
                </section>

                <!-- 3. Your Protocol -->
                <section class="fp-section" id="sectionProtocol">
                    <span class="fp-section__eyebrow" data-en="YOUR PROTOCOL" data-es="TU PROTOCOLO">YOUR PROTOCOL</span>
                    <p class="fp-section__intro" data-en="Your weekly behavioral experiment." data-es="Tu experimento conductual semanal.">Your weekly behavioral experiment.</p>
                    <div class="fp-action-card" id="actionCard"></div>
                </section>

                <!-- 4. Team Exercise -->
                <section class="fp-section" id="sectionTeam">
                    <span class="fp-section__eyebrow" data-en="TEAM EXERCISE" data-es="EJERCICIO DE EQUIPO">TEAM EXERCISE</span>
                    <div class="fp-team-card" id="teamCard"></div>
                </section>

                <!-- 5. Reflect (scrolls to reflection card) -->
                <section class="fp-section" id="sectionReflect">
                    <span class="fp-section__eyebrow" data-en="FOUNDER REFLECTION" data-es="REFLEXI&Oacute;N DEL FUNDADOR">FOUNDER REFLECTION</span>
                    <div class="fp-reflect-card" id="reflectCard"></div>
                </section>
            </div>
        </div>
    </div>

    <!-- Share Modal -->
    <div class="modal-overlay" id="shareModal">
        <div class="modal-content">
            <button class="modal-close" id="closeShare">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M18 6L6 18M6 6l12 12"/></svg>
            </button>
            <p class="modal-eyebrow" data-en="SHARE" data-es="COMPARTIR">SHARE</p>
            <h3 data-en="Share this exercise" data-es="Compartir este ejercicio">Share this exercise</h3>
            <div class="share-preview" id="sharePreview"></div>
            <div class="share-options">
                <button class="share-option" id="shareWA"><span>WhatsApp</span></button>
                <button class="share-option" id="shareEM"><span>Email</span></button>
                <button class="share-option" id="copyLink"><span data-en="Copy" data-es="Copiar">Copy</span></button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="fp-toast" id="fpToast"></div>

    <script src="js/businessProtocols.js?v=20260221"></script>
    <script src="js/storage.js?v=20260221"></script>
    <script>
        // =====================================================
        // STATE
        // =====================================================
        let currentProtocol = null;
        let currentLang = localStorage.getItem('berean_lang') || 'en';
        let currentCategory = 'all';
        let scrollSpyObserver = null;
        let indexScrollY = 0;

        // =====================================================
        // INIT
        // =====================================================
        document.addEventListener('DOMContentLoaded', () => {
            initLanguage();
            renderProtocolIndex();
            setupEventListeners();
            updateCredibilityLine();
        });

        // =====================================================
        // LANGUAGE
        // =====================================================
        function initLanguage() {
            document.querySelectorAll('.lang-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.lang === currentLang);
            });
            translatePage(currentLang);
        }

        function translatePage(lang) {
            document.querySelectorAll('[data-en]').forEach(el => {
                const text = el.getAttribute('data-' + lang);
                if (text) {
                    if (el.tagName === 'INPUT' || el.tagName === 'TEXTAREA') {
                        el.placeholder = text;
                    } else {
                        el.innerHTML = text;
                    }
                }
            });
            if (currentProtocol) renderProtocolDetail();
            else renderProtocolIndex();
            updateCredibilityLine();
        }

        // =====================================================
        // CREDIBILITY LINE
        // =====================================================
        function updateCredibilityLine() {
            let totalSources = 0;
            const evidenceKeys = ['biblicalContext', 'businessContext', 'neuroscience', 'behavioralScience', 'managementResearch'];
            BusinessProtocols.forEach(p => {
                evidenceKeys.forEach(key => {
                    const data = p.analysis[key];
                    if (data && data.sources) totalSources += data.sources.length;
                });
            });
            const el = document.getElementById('credibilityLine');
            if (el) {
                el.textContent = totalSources + (currentLang === 'en'
                    ? ' peer-reviewed and academic sources across 9 protocols.'
                    : ' fuentes acad\u00e9micas y revisadas por pares en 9 protocolos.');
            }
        }

        // =====================================================
        // LEVEL 1: PROTOCOL INDEX
        // =====================================================
        function renderProtocolIndex() {
            const container = document.getElementById('protocolCards');
            const protocols = currentCategory === 'all'
                ? BusinessProtocols
                : BusinessProtocols.filter(p => p.category === currentCategory);

            // Update tab counts
            updateTabCounts();

            // Get completed protocols
            let completedMap = {};
            try {
                const stored = localStorage.getItem('berean_business_progress');
                if (stored) completedMap = JSON.parse(stored);
            } catch (e) {}

            container.innerHTML = protocols.map((p, i) => {
                const globalIndex = BusinessProtocols.indexOf(p);
                const num = String(globalIndex + 1).padStart(2, '0');
                const keyRef = p.scriptures.filter(s => s.key).map(s => s.reference).join('; ');
                const title = p.title[currentLang];
                const categoryLabels = {
                    leadership: currentLang === 'en' ? 'Leadership' : 'Liderazgo',
                    strategy: currentLang === 'en' ? 'Strategy' : 'Estrategia',
                    resilience: currentLang === 'en' ? 'Resilience' : 'Resiliencia',
                    ethics: currentLang === 'en' ? 'Ethics' : 'Etica'
                };
                const categoryLabel = categoryLabels[p.category] || p.category;
                const isCompleted = completedMap[p.id] && completedMap[p.id].includes('completed');

                return '<div class="fp-card' + (isCompleted ? ' fp-card--completed' : '') + '" data-id="' + p.id + '">' +
                    '<span class="fp-card__number">' + num + '</span>' +
                    '<div class="fp-card__body">' +
                        '<span class="fp-card__category">' + categoryLabel + '</span>' +
                        '<h3 class="fp-card__title">' + title + '</h3>' +
                        '<span class="fp-card__ref">' + keyRef + '</span>' +
                    '</div>' +
                    '<div class="fp-card__right">' +
                        (isCompleted ? '<svg class="fp-card__check" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="20 6 9 17 4 12"/></svg>' : '') +
                        '<span class="fp-card__arrow">&rarr;</span>' +
                    '</div>' +
                '</div>';
            }).join('');

            // Staggered fade-in
            container.querySelectorAll('.fp-card').forEach((card, i) => {
                card.style.animationDelay = (i * 60) + 'ms';
                card.classList.add('fp-card--animate');
            });

            // Click handlers
            container.querySelectorAll('.fp-card').forEach(card => {
                card.addEventListener('click', () => {
                    const protocol = BusinessProtocols.find(p => p.id === card.dataset.id);
                    if (protocol) openProtocol(protocol);
                });
            });
        }

        function updateTabCounts() {
            const counts = { all: BusinessProtocols.length };
            BusinessProtocols.forEach(p => {
                counts[p.category] = (counts[p.category] || 0) + 1;
            });
            document.querySelectorAll('.fp-tab').forEach(tab => {
                const cat = tab.dataset.category;
                if (cat === 'all') {
                    tab.setAttribute('data-en', 'All (' + counts.all + ')');
                    tab.setAttribute('data-es', 'Todos (' + counts.all + ')');
                }
            });
        }

        // =====================================================
        // LEVEL 2: PROTOCOL DETAIL
        // =====================================================
        function openProtocol(protocol) {
            currentProtocol = protocol;
            indexScrollY = window.scrollY;

            document.getElementById('protocolIndex').style.display = 'none';
            document.getElementById('protocolDetail').style.display = 'block';

            renderProtocolDetail();
            window.scrollTo({ top: 0 });

            // Load saved state
            loadProtocolState(protocol.id);

            // Setup scroll spy
            setTimeout(() => setupScrollSpy(), 100);
        }

        function renderProtocolDetail() {
            if (!currentProtocol) return;
            const p = currentProtocol;
            const a = p.analysis;
            const lang = currentLang;
            const globalIndex = BusinessProtocols.indexOf(p);
            const num = String(globalIndex + 1).padStart(2, '0');

            // Nav title
            document.getElementById('detailNavTitle').textContent = p.title[lang];

            // Header
            const categoryLabels = {
                leadership: lang === 'en' ? 'Leadership' : 'Liderazgo',
                strategy: lang === 'en' ? 'Strategy' : 'Estrategia',
                resilience: lang === 'en' ? 'Resilience' : 'Resiliencia',
                ethics: lang === 'en' ? 'Ethics' : 'Etica'
            };
            document.getElementById('detailHeader').innerHTML =
                '<div class="fp-detail-header__meta">' +
                    '<span class="fp-card__category">' + (categoryLabels[p.category] || p.category) + '</span>' +
                    '<span class="fp-detail-header__num">' + (lang === 'en' ? 'Protocol ' : 'Protocolo ') + num + '</span>' +
                '</div>' +
                '<h1 class="fp-detail-header__title">' + p.title[lang] + '</h1>' +
                '<p class="fp-detail-header__refs">' + p.scriptures.map(s => s.reference).join(' &middot; ') + '</p>' +
                '<div class="fp-disciplines fp-disciplines--detail">' +
                    '<span class="fp-discipline">' + (lang === 'en' ? 'Biblical Exegesis' : 'Exegesis Biblica') + '</span>' +
                    '<span class="fp-discipline">' + (lang === 'en' ? 'Neuroscience' : 'Neurociencia') + '</span>' +
                    '<span class="fp-discipline">' + (lang === 'en' ? 'Behavioral Science' : 'Ciencia del Comportamiento') + '</span>' +
                    '<span class="fp-discipline">' + (lang === 'en' ? 'Management Research' : 'Investigacion en Gestion') + '</span>' +
                '</div>';

            // Scripture card
            document.getElementById('scriptureCard').innerHTML =
                '<blockquote class="fp-scripture__quote">' + a.scriptureText[lang] + '</blockquote>' +
                '<span class="fp-scripture__ref">' + p.scriptures.filter(s => s.key).map(s => s.reference).join('; ') + '</span>';

            // Evidence accordions
            const evidenceItems = [
                { key: 'biblicalContext', label: { en: 'Biblical Context', es: 'Contexto Biblico' } },
                { key: 'businessContext', label: { en: 'Business Context', es: 'Contexto Empresarial' } },
                { key: 'neuroscience', label: { en: 'Neuroscience', es: 'Neurociencia' } },
                { key: 'behavioralScience', label: { en: 'Behavioral Science', es: 'Ciencia del Comportamiento' } },
                { key: 'managementResearch', label: { en: 'Management Research', es: 'Investigacion en Gestion' } }
            ];

            document.getElementById('evidenceAccordions').innerHTML = evidenceItems.map(item => {
                const data = a[item.key];
                if (!data) return '';
                const text = typeof data === 'string' ? data : (data[lang] || '');
                const sources = data.sources || [];
                const sourceField = lang === 'es' ? 'citationEs' : 'citation';
                const sourceCount = sources.length;
                const badge = sourceCount > 0 ? ' <span class="fp-accordion__badge">(' + sourceCount + ' ' + (sourceCount === 1 ? (lang === 'en' ? 'source' : 'fuente') : (lang === 'en' ? 'sources' : 'fuentes')) + ')</span>' : '';

                let sourcesHTML = '';
                if (sourceCount > 0) {
                    sourcesHTML = '<div class="fp-accordion__sources">' +
                        sources.map(s => {
                            const typeLabel = s.type === 'peer-reviewed' ? 'PEER-REVIEWED' : (s.type === 'academic' ? 'ACADEMIC' : 'INDUSTRY');
                            const typeClass = s.type === 'peer-reviewed' ? 'fp-source--peer' : (s.type === 'academic' ? 'fp-source--academic' : 'fp-source--industry');
                            return '<p class="fp-source"><span class="fp-source__type ' + typeClass + '">' + typeLabel + '</span> ' + (s[sourceField] || s.citation) + '</p>';
                        }).join('') +
                    '</div>';
                }

                return '<details class="fp-accordion">' +
                    '<summary class="fp-accordion__header">' +
                        '<span class="fp-accordion__title">' + item.label[lang] + badge + '</span>' +
                        '<svg class="fp-accordion__icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>' +
                    '</summary>' +
                    '<div class="fp-accordion__body">' +
                        '<p>' + text + '</p>' +
                        sourcesHTML +
                    '</div>' +
                '</details>';
            }).join('');

            // Setup one-at-a-time accordion behavior
            setupAccordionBehavior();

            // Action card (protocol + commitment)
            document.getElementById('actionCard').innerHTML =
                '<div class="fp-action-card__experiment">' +
                    '<p>' + a.weeklyProtocol[lang] + '</p>' +
                    '<label class="fp-action-card__commit">' +
                        '<input type="checkbox" id="commitCheckbox">' +
                        '<span class="fp-action-card__checkbox"></span>' +
                        '<span data-en="I commit to this experiment" data-es="Me comprometo con este experimento">' + (lang === 'en' ? 'I commit to this experiment' : 'Me comprometo con este experimento') + '</span>' +
                    '</label>' +
                '</div>';

            // Team card
            const te = a.teamExercise;
            document.getElementById('teamCard').innerHTML =
                '<h3 class="fp-team-card__title">' + te.title[lang] + '</h3>' +
                '<div class="fp-team-meta">' +
                    '<span class="fp-meta-pill">' + te.duration[lang] + '</span>' +
                    '<span class="fp-meta-pill">' + te.teamSize[lang] + '</span>' +
                '</div>' +
                '<p class="fp-team-card__desc">' + te.description[lang] + '</p>' +
                '<ol class="fp-team-steps">' + te.steps[lang].map(s => '<li>' + s + '</li>').join('') + '</ol>' +
                '<div class="fp-team-questions">' +
                    '<h4>' + (lang === 'en' ? 'Discussion Questions' : 'Preguntas de Discusion') + '</h4>' +
                    '<ul>' + te.discussionQuestions[lang].map(q => '<li>' + q + '</li>').join('') + '</ul>' +
                '</div>' +
                '<div class="fp-team-actions">' +
                    '<button class="fp-team-actions__btn" id="copyExercise">' +
                        '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2"/><path d="M5 15H4a2 2 0 01-2-2V4a2 2 0 012-2h9a2 2 0 012 2v1"/></svg>' +
                        '<span>' + (lang === 'en' ? 'Copy' : 'Copiar') + '</span>' +
                    '</button>' +
                    '<button class="fp-team-actions__btn" id="shareExercise">' +
                        '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="18" cy="5" r="3"/><circle cx="6" cy="12" r="3"/><circle cx="18" cy="19" r="3"/><line x1="8.59" y1="13.51" x2="15.42" y2="17.49"/><line x1="15.41" y1="6.51" x2="8.59" y2="10.49"/></svg>' +
                        '<span>' + (lang === 'en' ? 'Share' : 'Compartir') + '</span>' +
                    '</button>' +
                '</div>';

            // Reflect card
            document.getElementById('reflectCard').innerHTML =
                '<p class="fp-reflect-card__question">' + a.founderReflection[lang] + '</p>' +
                '<textarea class="fp-reflect-card__textarea" id="reflectionTextarea" placeholder="' + (lang === 'en' ? 'What came up for you?' : 'Que te surgio?') + '"></textarea>';

            // Rebind dynamic event listeners
            bindDetailEvents();
        }

        function loadProtocolState(protocolId) {
            // Load journal
            const saved = localStorage.getItem('berean-journal-' + protocolId);
            setTimeout(() => {
                const textarea = document.getElementById('reflectionTextarea');
                if (textarea && saved) textarea.value = saved;
            }, 50);

            // Load commitment
            const committed = localStorage.getItem('berean-commit-' + protocolId);
            setTimeout(() => {
                const cb = document.getElementById('commitCheckbox');
                if (cb && committed === 'true') cb.checked = true;
            }, 50);

            // Load completion state
            let progress = {};
            try {
                const stored = localStorage.getItem('berean_business_progress');
                if (stored) progress = JSON.parse(stored);
            } catch (e) {}
            const isCompleted = progress[protocolId] && progress[protocolId].includes('completed');
            setTimeout(() => {
                const mc = document.getElementById('markCompleteCheckbox');
                if (mc) mc.checked = isCompleted;
            }, 50);
        }

        function setupAccordionBehavior() {
            const container = document.getElementById('evidenceAccordions');
            container.querySelectorAll('details').forEach(detail => {
                detail.addEventListener('toggle', () => {
                    if (detail.open) {
                        container.querySelectorAll('details').forEach(sibling => {
                            if (sibling !== detail && sibling.open) sibling.open = false;
                        });
                    }
                });
            });
        }

        // =====================================================
        // SCROLL SPY
        // =====================================================
        function setupScrollSpy() {
            if (scrollSpyObserver) scrollSpyObserver.disconnect();

            const sections = document.querySelectorAll('#protocolDetail .fp-section');
            const tocItems = document.querySelectorAll('.fp-toc__item');

            scrollSpyObserver = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        const id = entry.target.id;
                        tocItems.forEach(item => {
                            item.classList.toggle('fp-toc__item--active', item.dataset.target === id);
                        });
                    }
                });
            }, { threshold: 0.2, rootMargin: '-80px 0px -60% 0px' });

            sections.forEach(section => scrollSpyObserver.observe(section));
        }

        // =====================================================
        // BACK TO INDEX
        // =====================================================
        function backToIndex() {
            if (scrollSpyObserver) scrollSpyObserver.disconnect();
            document.getElementById('protocolDetail').style.display = 'none';
            document.getElementById('protocolIndex').style.display = 'block';
            currentProtocol = null;
            renderProtocolIndex();
            window.scrollTo({ top: indexScrollY });
        }

        // =====================================================
        // TOAST
        // =====================================================
        function showToast(message) {
            const toast = document.getElementById('fpToast');
            toast.textContent = message;
            toast.classList.add('fp-toast--visible');
            setTimeout(() => toast.classList.remove('fp-toast--visible'), 2000);
        }

        // =====================================================
        // EVENT LISTENERS
        // =====================================================
        function setupEventListeners() {
            // Language toggle
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('lang-btn')) {
                    currentLang = e.target.dataset.lang;
                    localStorage.setItem('berean_lang', currentLang);
                    document.querySelectorAll('.lang-btn').forEach(b => {
                        b.classList.toggle('active', b.dataset.lang === currentLang);
                    });
                    translatePage(currentLang);
                }
            });

            // Category tabs
            document.getElementById('categoryTabs').addEventListener('click', (e) => {
                const tab = e.target.closest('.fp-tab');
                if (!tab) return;
                document.querySelectorAll('.fp-tab').forEach(t => t.classList.remove('fp-tab--active'));
                tab.classList.add('fp-tab--active');
                currentCategory = tab.dataset.category;
                renderProtocolIndex();
            });

            // Back to index
            document.getElementById('backToIndex').addEventListener('click', backToIndex);

            // TOC clicks
            document.querySelectorAll('.fp-toc__item').forEach(item => {
                item.addEventListener('click', () => {
                    const target = document.getElementById(item.dataset.target);
                    if (target) {
                        target.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }
                });
            });

            // Mark complete
            document.getElementById('markCompleteCheckbox').addEventListener('change', (e) => {
                if (!currentProtocol) return;
                if (e.target.checked) {
                    StorageManager.saveBusinessProgress(currentProtocol.id, ['completed']);
                    showToast(currentLang === 'en' ? 'Protocol marked complete' : 'Protocolo marcado como completo');
                } else {
                    // Unmark
                    StorageManager.saveBusinessProgress(currentProtocol.id, []);
                }
            });

            // Share modal
            document.getElementById('closeShare').addEventListener('click', () => {
                document.getElementById('shareModal').classList.remove('active');
            });
            document.getElementById('shareWA').addEventListener('click', shareToWhatsApp);
            document.getElementById('shareEM').addEventListener('click', shareToEmail);
            document.getElementById('copyLink').addEventListener('click', copyToClipboard);
        }

        function bindDetailEvents() {
            // Commitment checkbox
            const commitCb = document.getElementById('commitCheckbox');
            if (commitCb) {
                commitCb.addEventListener('change', (e) => {
                    if (!currentProtocol) return;
                    localStorage.setItem('berean-commit-' + currentProtocol.id, e.target.checked ? 'true' : 'false');
                    if (e.target.checked) {
                        StorageManager.saveBusinessProgress(currentProtocol.id, ['committed']);
                    }
                });
            }

            // Journal auto-save
            const textarea = document.getElementById('reflectionTextarea');
            if (textarea) {
                textarea.addEventListener('input', (e) => {
                    if (!currentProtocol) return;
                    if (e.target.value) {
                        localStorage.setItem('berean-journal-' + currentProtocol.id, e.target.value);
                    } else {
                        localStorage.removeItem('berean-journal-' + currentProtocol.id);
                    }
                });
            }

            // Copy exercise
            const copyBtn = document.getElementById('copyExercise');
            if (copyBtn) {
                copyBtn.addEventListener('click', copyExerciseToClipboard);
            }

            // Share exercise
            const shareBtn = document.getElementById('shareExercise');
            if (shareBtn) {
                shareBtn.addEventListener('click', () => {
                    document.getElementById('shareModal').classList.add('active');
                    updateSharePreview();
                });
            }
        }

        // =====================================================
        // COPY / SHARE
        // =====================================================
        function copyExerciseToClipboard() {
            if (!currentProtocol) return;
            const te = currentProtocol.analysis.teamExercise;
            const lang = currentLang;
            const text = te.title[lang] + '\n' +
                te.duration[lang] + ' | ' + te.teamSize[lang] + '\n\n' +
                te.description[lang] + '\n\n' +
                (lang === 'en' ? 'Steps:' : 'Pasos:') + '\n' +
                te.steps[lang].map((s, i) => (i + 1) + '. ' + s).join('\n') + '\n\n' +
                (lang === 'en' ? 'Discussion Questions:' : 'Preguntas de Discusion:') + '\n' +
                te.discussionQuestions[lang].map(q => '- ' + q).join('\n') +
                '\n\n-- via Berean for Founders';

            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyExercise');
                const origText = btn.querySelector('span').textContent;
                btn.querySelector('span').textContent = currentLang === 'en' ? 'Copied!' : 'Copiado!';
                setTimeout(() => btn.querySelector('span').textContent = origText, 2000);
            });
        }

        function shareToWhatsApp() {
            if (!currentProtocol) return;
            const p = currentProtocol;
            const ref = p.scriptures.filter(s => s.key).map(s => s.reference).join('; ');
            const text = '*' + p.title[currentLang] + '*\n' + ref + '\n\n"' +
                p.analysis.scriptureText[currentLang].slice(0, 200) + '..."\n\n-- via Berean for Founders';
            window.open('https://wa.me/?text=' + encodeURIComponent(text), '_blank');
        }

        function shareToEmail() {
            if (!currentProtocol) return;
            const p = currentProtocol;
            const subject = p.title[currentLang] + ' - Berean for Founders';
            const body = p.title[currentLang] + '\n\n' + p.analysis.scriptureText[currentLang].slice(0, 300) + '...';
            window.open('mailto:?subject=' + encodeURIComponent(subject) + '&body=' + encodeURIComponent(body), '_blank');
        }

        function copyToClipboard() {
            if (!currentProtocol) return;
            const p = currentProtocol;
            const text = p.title[currentLang] + '\n' +
                p.scriptures.filter(s => s.key).map(s => s.reference).join('; ') + '\n\n' +
                p.analysis.weeklyProtocol[currentLang] + '\n\n-- via Berean for Founders';
            navigator.clipboard.writeText(text).then(() => {
                const btn = document.getElementById('copyLink');
                const origHTML = btn.innerHTML;
                btn.innerHTML = '<span>' + (currentLang === 'en' ? 'Copied!' : 'Copiado!') + '</span>';
                setTimeout(() => btn.innerHTML = origHTML, 2000);
            });
        }

        function updateSharePreview() {
            if (!currentProtocol) return;
            const ref = currentProtocol.scriptures.filter(s => s.key).map(s => s.reference).join('; ');
            document.getElementById('sharePreview').innerHTML =
                '<strong>' + currentProtocol.title[currentLang] + '</strong>' +
                '<p>' + ref + '</p>';
        }
    </script>
<script defer src="/_vercel/insights/script.js"></script>
<script defer src="/_vercel/speed-insights/script.js"></script>
</body>
</html>
